# M5 AI FAE MCP 要件仕様書

## 1. 文書の目的
本書は、M5 AI FAE（Field Application Engineer）との対話を自動化し、M5Stack製品に関する技術情報を効率的に取得するためのシステム要件を定義したものです。特に、AtomS3 LiteとGPSモジュール（AtomicBase GPS）の接続に関する情報取得を主な目的としています。

---

## 2. プロジェクト概要

### 2.1 開発の背景
- M5Stack製品の技術情報を取得するには、通常M5 AI FAEとの対話が必要となる
- 同じ質問を繰り返し行う場合や、大量の技術情報を取得する場合に、手動での対話は非効率的
- Playwrightを使用した自動化により、効率的かつ一貫性のある情報取得が可能になる

### 2.2 目的
- M5 AI FAEとの対話を自動化し、M5Stack製品に関する技術情報を効率的に取得する
- 特にAtomS3 LiteとGPSモジュール（AtomicBase GPS）の接続方法に関する情報を取得する
- 取得した情報を構造化された形式で保存し、後続の開発作業に活用できるようにする

### 2.3 ステークホルダー
- **エンドユーザー:** M5Stack製品の開発者、技術者
- **開発チーム:** 自動化スクリプト開発者、テスト担当者
- **関係者:** M5Stack社、AI FAEシステム管理者

---

## 3. システム概要

### 3.1 システム構成
- **Node.js環境:**
  - Playwrightフレームワークを使用したブラウザ自動化
  - ファイルシステムへのログ保存機能

- **M5 AI FAE:**
  - Webベースのチャットインターフェース（https://chat.m5stack.com/）
  - 日本語および英語インターフェースへの対応

- **ハードウェア情報:**
  - AtomS3 Lite: 対象となるM5Stack製品
  - AtomicBase GPS: 接続対象のGPSモジュール
    - GPS_TX_PIN = 5
    - GPS_RX_PIN = -1

---

## 4. 機能要件

### 4.1 自動対話機能

1. **M5 AI FAEへのアクセス**
   - M5 AI FAEのWebインターフェースに自動的にアクセスする
   - ページの読み込み完了を確実に検出する

2. **質問の送信**
   - 定義された質問テキストをチャットインターフェースに入力する
   - 送信ボタンをクリックして質問を送信する
   - 日本語および英語インターフェースの両方に対応する

3. **回答の待機と取得**
   - 「考え中...」インジケータの表示と非表示を検出する
   - 回答が完全に表示されるまで適切に待機する
   - 回答テキストとHTML形式の両方を取得する

4. **提案質問のフォローアップ（オプション）**
   - M5 AI FAEが提案する関連質問を検出する
   - 提案質問をクリックして追加情報を取得する
   - フォローアップ回答も同様に保存する

5. **回答内容の検証**
   - GPSモジュールの接続情報（TX/RXピン）が含まれているか確認する
   - AtomS3 Liteに関する情報が含まれているか確認する
   - 回答の長さや内容が適切かどうか検証する

### 4.2 出力機能

1. **スクリーンショット取得**
   - 対話の各段階でスクリーンショットを取得する
   - タイムスタンプ付きのファイル名で保存する

2. **テキスト出力**
   - 回答テキストをプレーンテキスト形式で保存する
   - HTML形式の回答も保存し、書式やコードブロックを維持する

3. **構造化データ**
   - 回答をJSON形式で構造化して保存する
   - 質問と回答のペアを関連付けて保存する

---

## 5. 非機能要件

### 5.1 信頼性
- 不安定なネットワーク環境でも動作するよう、適切なタイムアウト設定を行う
- UIの変更に対応できるよう、複数のセレクタを試行する機能を実装する
- エラーが発生した場合も、適切にログを残し、可能な限り処理を継続する

### 5.2 保守性
- コードは適切に構造化し、メンテナンスしやすい設計とする
- UIの変更に対応するため、セレクタは一箇所で管理する
- 詳細なログ出力により、問題発生時のデバッグを容易にする

### 5.3 拡張性
- 新しい質問パターンを容易に追加できる設計とする
- 出力形式を拡張できるようにする
- 将来的な機能追加（例：定期実行、複数質問の一括処理など）に対応できる設計とする

### 5.4 ユーザビリティ
- テスト実行時にブラウザを表示し、対話プロセスを視覚的に確認できるようにする
- ヘッドレスモードでの実行オプションも提供し、バックグラウンド処理を可能にする
- 詳細なレポート機能により、テスト結果を容易に確認できるようにする

---

## 6. テスト要件

### 6.1 テスト環境
- Playwright Test Frameworkを使用した自動テスト
- 異なるブラウザ（Chromium、Firefox、WebKit）での動作確認
- ヘッドレスモードおよび可視モードでのテスト

### 6.2 テスト項目
- 基本的な質問-回答フローのテスト
- 日本語および英語インターフェースでのテスト
- エラー処理（タイムアウト、セレクタ不一致など）のテスト
- 出力ファイルの検証

### 6.3 テストレポート
- HTML形式のレポートを生成し、テスト結果を視覚的に確認できるようにする
- JSON形式のレポートも生成し、プログラムによる結果解析を可能にする
- スクリーンショットやトレースを保存し、問題発生時の原因特定を容易にする

---

## 7. 実装方針

### 7.1 開発環境
- Node.js
- Playwright
- Playwright Test Framework
- ファイル操作用のfs、pathモジュール

### 7.2 ディレクトリ構造
```
M5Stack_AI_FAE_MCP/
├── doc/                    # ドキュメント
│   ├── m5ai_mcp.md         # 詳細ガイド
│   └── requirements_ja.md  # 本要件仕様書
├── test/                   # テストコード
│   ├── fixtures/           # テスト用の共通フィクスチャ
│   │   └── m5ai-fixture.js # 日本語ブラウザ設定などの共通フィクスチャ
│   ├── logs/               # テスト実行時のログファイル保存先
│   ├── reports/            # テストレポート出力先
│   │   ├── html-report/    # HTML形式のレポート
│   │   └── test-results/   # テスト結果（スクリーンショットなど）
│   ├── specs/              # テスト仕様ファイル
│   │   └── m5ai.spec.js    # M5 AI FAEとの対話テスト
│   └── utils/              # 共通ユーティリティ
│       ├── logger.js       # ログ関連のユーティリティ
│       └── m5ai-helper.js  # M5 AI FAE対話用ヘルパー関数
├── package.json            # プロジェクト設定
├── playwright.config.js    # Playwright設定
└── README.md               # 概要ファイル
```

### 7.3 実装手順
1. 基本的なPlaywright環境のセットアップ
2. M5 AI FAEへのアクセスと対話の自動化
3. 回答取得とファイル保存機能の実装
4. エラー処理とリトライメカニズムの追加
5. テストケースの作成と実行
6. ドキュメントの整備

### 7.4 実行モード
1. **通常モード（ブラウザ表示あり）**
   - テスト実行時にブラウザウィンドウが表示される
   - 対話プロセスを視覚的に確認できる
   - デバッグが容易

2. **ヘッドレスモード（ブラウザ表示なし）**
   - バックグラウンドでテストが実行される
   - リソース使用量が少ない
   - CI/CD環境での実行に適している

---

## 8. リスクと対応策

### 8.1 UIの変更
- **リスク**: M5 AI FAEのWebインターフェースが更新され、セレクタが機能しなくなる
- **対策**: 複数のセレクタを試行する機能を実装し、UIの変更に対応する

### 8.2 ネットワーク問題
- **リスク**: 不安定なネットワーク環境で接続が切断される
- **対策**: 適切なタイムアウト設定とリトライメカニズムを実装する

### 8.3 回答形式の変更
- **リスク**: M5 AI FAEの回答形式が変更される
- **対策**: 回答取得ロジックを柔軟に設計し、複数の取得方法を用意する

### 8.4 ブラウザの互換性
- **リスク**: 特定のブラウザでのみ動作し、他のブラウザでは問題が発生する
- **対策**: 複数のブラウザでテストを実行し、互換性を確保する

---

## 9. 付録

### 9.1 用語集
- **M5 AI FAE**: M5Stack社が提供するAIベースのField Application Engineer
- **Playwright**: Microsoftが開発したブラウザ自動化ライブラリ
- **AtomS3 Lite**: M5Stack社のマイクロコントローラモジュール
- **AtomicBase GPS**: M5Stack社のGPSモジュール
- **ヘッドレスモード**: ブラウザのUIを表示せずに実行するモード

### 9.2 参考資料
- Playwright公式ドキュメント: https://playwright.dev/
- M5Stack公式サイト: https://m5stack.com/
- M5 AI FAE: https://chat.m5stack.com/
